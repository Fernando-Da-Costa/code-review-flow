name: Criar Issue de Teste

on:
  push:

permissions:
  issues: write
  projects: write

jobs:
  Criar-Issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Criar Issue via API
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "Issue de Teste Automática"
          content-filepath: .github/ISSUE_TEMPLATE/general_issue.md
          labels: needs-review
          token: ${{ secrets.MY_PAT }}

      - name: Instalar GitHub CLI
        run: sudo apt-get update && sudo apt-get install -y gh jq

      - name: Aguarda criação da issue
        run: sleep 5

      - name: Obter última issue criada
        id: get_issue
        run: |
          ISSUE=$(gh issue list --limit 1 --label "needs-review" --state open --json url,id --jq '.[0]')
          ISSUE_URL=$(echo "$ISSUE" | jq -r '.url')
          ISSUE_ID=$(echo "$ISSUE" | jq -r '.id')
          echo "ISSUE_URL=$ISSUE_URL" >> $GITHUB_ENV
          echo "ISSUE_ID=$ISSUE_ID" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}

      - name: Obter ID do ProjectV2
        id: get_project
        run: |
          PROJECT_ID=$(gh api graphql -f query='
            {
              user(login: "Fernando-Da-Costa") {
                projectsV2(first: 10) {
                  nodes {
                    id
                    title
                  }
                }
              }
            }' --jq '.data.user.projectsV2.nodes[] | select(.title == "PR Review Board") | .id')
          echo "PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}

      - name: Adicionar issue ao Project Board via GraphQL
        run: |
          echo "Adicionando issue $ISSUE_URL ao projeto $PROJECT_ID"
          if [ -z "$ISSUE_ID" ] || [ -z "$PROJECT_ID" ]; then
            echo "❌ERROR: ISSUE_ID ou PROJECT_ID está vazio"
            exit 1
          fi
          gh api graphql -f query='
            mutation($projectId:ID!, $contentId:ID!) {
              addProjectV2ItemById(input: {projectId: $projectId, contentId: $contentId}) {
                item {
                  id
                }
              }
            }' \
            -f projectId="$PROJECT_ID" \
            -f contentId="$ISSUE_ID"
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          ISSUE_ID: ${{ env.ISSUE_ID }}
          PROJECT_ID: ${{ env.PROJECT_ID }}
          ISSUE_URL: ${{ env.ISSUE_URL }}
